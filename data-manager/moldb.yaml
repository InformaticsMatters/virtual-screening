---
kind: DataManagerJobDefinition
kind-version: '2021.1'
name: MolDB tools
collection: moldb
repository-url: https://github.com/InformaticsMatters/virtual-screening/moldb.yaml
repository-tag: '1.0.0'

test-groups:
- name: moldb
  compose:
    file: docker-compose-moldb.yaml
    delay-seconds: 5
  environment:
  - POSTGRES_SERVER: postgres
  - POSTGRES_DATABASE: postgres
  - POSTGRES_USERNAME: postgres
  - POSTGRES_PASSWORD: squonk

jobs:
  moldb-create-tables:
    name: Create MolDB database tables
    description: >-
      Create MolDB database tables
    version: '1.0.0'
    # no category as this is only used as part of testing
    keywords:
    - moldb
    - database
    image:
      name: informaticsmatters/vs-moldb
      tag: 'latest'
      project-directory: /data
      working-directory: /data
      type: simple
      environment:
      - name: POSTGRES_USERNAME
        value-from:
          secret:
            name: moldb-database
            key: moldb_username
      - name: POSTGRES_PASSWORD
        value-from:
          secret:
            name: moldb-database
            key: moldb_password
      - name: POSTGRES_SERVER
        value-from:
          secret:
            name: moldb-database
            key: moldb_server
      - name: POSTGRES_DATABASE
        value-from:
          secret:
            name: moldb-database
            key: moldb_database
    command: >-
      python -m moldb.create_db
    tests:
      create:
        run-groups:
        - name: moldb
          ordinal: 1
        environment:
        - POSTGRES_USERNAME
        - POSTGRES_PASSWORD
        - POSTGRES_SERVER
        - POSTGRES_DATABASE
        checks:
          exitCode: 0

  moldb-count-rows:
    name: MolDB count rows
    description: >-
      Verify there are the expected number of rows in a database table
    version: '1.0.0'
    # no category as this is only used as part of testing
    keywords:
    - moldb
    - database
    image:
      name: informaticsmatters/vs-moldb
      tag: 'latest'
      project-directory: /data
      working-directory: /data
      type: simple
      environment:
      - name: POSTGRES_USERNAME
        value-from:
          secret:
            name: moldb-database
            key: moldb_username
      - name: POSTGRES_PASSWORD
        value-from:
          secret:
            name: moldb-database
            key: moldb_password
      - name: POSTGRES_SERVER
        value-from:
          secret:
            name: moldb-database
            key: moldb_server
      - name: POSTGRES_DATABASE
        value-from:
          secret:
            name: moldb-database
            key: moldb_database
    command: >-
      python -m moldb.count_rows --table-name '{{ table }}'
      {% if count is defined %}--expected-rows {{ count }}{% endif %}
      {% if min_rows is defined %}--min-rows {{ min_rows }}{% endif %}
      {% if max_rows is defined %}--max-rows {{ max_rows }}{% endif %}
    options:
      type: object
      required:
      - table
      - count
      - min_rows
      - max_rows
      properties:
        table:
          title: Table name
          pattern: "^[A-Za-z0-9_\\.\\-]+$"
        count:
          title: Expected row count
          type: integer
    tests:
      supply:
        run-groups:
        - name: moldb
          ordinal: 3
        environment:
        - POSTGRES_USERNAME
        - POSTGRES_PASSWORD
        - POSTGRES_SERVER
        - POSTGRES_DATABASE
        options:
          table: supply
          count: 1000
        checks:
          exitCode: 0
      enumeration:
        run-groups:
        - name: moldb
          ordinal: 6
        environment:
        - POSTGRES_USERNAME
        - POSTGRES_PASSWORD
        - POSTGRES_SERVER
        - POSTGRES_DATABASE
        options:
          table: enumeration
          count: 523
        checks:
          exitCode: 0
      conformer:
        run-groups:
        - name: moldb
          ordinal: 8
        environment:
        - POSTGRES_USERNAME
        - POSTGRES_PASSWORD
        - POSTGRES_SERVER
        - POSTGRES_DATABASE
        options:
          table: conformer
          min_rows: 9000
          max_rows: 11000
        checks:
          exitCode: 0

  moldb-load-library:
    name: MolDB load library
    description: >-
      Load compound library into MolDB
    version: '1.0.0'
    category: ligand preparation
    keywords:
    - moldb
    - database
    - library
    image:
      name: informaticsmatters/vs-nextflow
      tag: 'latest'
      project-directory: /data
      working-directory: /data
      type: nextflow
      environment:
      - name: POSTGRES_USERNAME
        value-from:
          secret:
            name: moldb-database
            key: moldb_username
      - name: POSTGRES_PASSWORD
        value-from:
          secret:
            name: moldb-database
            key: moldb_password
      - name: POSTGRES_SERVER
        value-from:
          secret:
            name: moldb-database
            key: moldb_server
      - name: POSTGRES_DATABASE
        value-from:
          secret:
            name: moldb-database
            key: moldb_database
      fix-permissions: false # no outputs
    command: >-
      nextflow -log {{ DM_INSTANCE_DIRECTORY }}/nextflow.log
      run {{ CODE_DIRECTORY|default('/code') }}/moldb/load_library.nf
      --inputs '{{ input }}'
      --library_name '{{ library }}'
      --name_col {{ id_col }}
      {% if chunk_size is defined %}--chunk_size {{ chunk_size }}{% endif %}
      {% if header is defined and header %}--header{% endif %}
      --delimiter '{{ delimiter }}'
      --interval 10000
      -with-trace {{ DM_INSTANCE_DIRECTORY }}/trace.txt
      -with-report {{ DM_INSTANCE_DIRECTORY }}/report.html
    variables:
      order:
        options:
        - library
        - id_col
        - delimiter
        - header
        - chunk_size
      inputs:
        type: object
        required:
        - input
        properties:
          input:
            title: Molecules to load (.smi)
            mime-types:
            - squonk/x-smiles
            - chemical/x-daylight-smiles
            type: file
      # no outputs
      options:
        type: object
        required:
        - library
        - id_col
        - delimiter
        properties:
          library:
            title: Library name
            type: string
            pattern: "^[A-Za-z0-9][A-Za-z0-9_/\\- ]+$"
          id_col:
            title: Index of ID field (zero based)
            type: integer
            default: 1
          delimiter:
            title: Delimiter
            type: string
            default: tab
            enum:
            - tab
            - comma
            - space
            - pipe
          header:
            title: Skip header line
            type: boolean
            default: false
          chunk_size:
            title: Chunk size for splitting
            type: integer
            default: 100000
            minValue: 10000
            maxValue: 1000000
    tests:
      simple-load:
        nextflow-config-file: nextflow-moldb.config
        run-groups:
        - name: moldb
          ordinal: 2
        environment:
        - POSTGRES_USERNAME
        - POSTGRES_PASSWORD
        - POSTGRES_SERVER
        - POSTGRES_DATABASE
        inputs:
          input: data/1000.smi
        options:
          library: test
          id_col: 1
          delimiter: tab
          header: false
          chunk_size: 250
        checks:
          exitCode: 0

  moldb-calc-props:
    name: MolDB molecular properties
    description: >-
      Calculate molecular properties and load into MolDB
    version: '1.0.0'
    category: ligand preparation
    keywords:
    - moldb
    - database
    - molecular properties
    image:
      name: informaticsmatters/vs-nextflow
      tag: 'latest'
      project-directory: /data
      working-directory: /data
      type: nextflow
      environment:
      - name: POSTGRES_USERNAME
        value-from:
          secret:
            name: moldb-database
            key: moldb_username
      - name: POSTGRES_PASSWORD
        value-from:
          secret:
            name: moldb-database
            key: moldb_password
      - name: POSTGRES_SERVER
        value-from:
          secret:
            name: moldb-database
            key: moldb_server
      - name: POSTGRES_DATABASE
        value-from:
          secret:
            name: moldb-database
            key: moldb_database
      fix-permissions: false # no outputs
    command: >-
      nextflow -log {{ DM_INSTANCE_DIRECTORY }}/nextflow.log
      run {{ CODE_DIRECTORY|default('/code') }}/moldb/calc_molprops.nf
      {% if chunk_size is defined %}--chunk_size {{ chunk_size }}{% endif %}
      --count {{ count }}
      -with-trace {{ DM_INSTANCE_DIRECTORY }}/trace.txt
      -with-report {{ DM_INSTANCE_DIRECTORY }}/report.html
    variables:
      # no inputs
      # no outputs
      options:
        type: object
        required:
        - count
        properties:
          count:
            title: Max number of molecules to process
            type: integer
            default: 1000000
            maxValue: 5000000
          chunk_size:
            title: Chunk size for splitting
            type: integer
            default: 50000
            minValue: 10000
            maxValue: 1000000
    tests:
      simple-calc:
        nextflow-config-file: nextflow-moldb.config
        run-groups:
        - name: moldb
          ordinal: 4
        environment:
        - POSTGRES_USERNAME
        - POSTGRES_PASSWORD
        - POSTGRES_SERVER
        - POSTGRES_DATABASE
        options:
          count: 1000
          chunk_size: 25
        checks:
          exitCode: 0

  moldb-enumerate-mols:
    name: MolDB enumerate forms
    description: >-
      Enumerate tautomers, microstates and stereoisomers
    version: '1.0.0'
    category: ligand preparation
    keywords:
    - moldb
    - database
    - enumerate
    - microstates
    - tautomers
    - stereoisomers
    image:
      name: informaticsmatters/vs-nextflow
      tag: 'latest'
      project-directory: /data
      working-directory: /data
      type: nextflow
      environment:
      - name: POSTGRES_USERNAME
        value-from:
          secret:
            name: moldb-database
            key: moldb_username
      - name: POSTGRES_PASSWORD
        value-from:
          secret:
            name: moldb-database
            key: moldb_password
      - name: POSTGRES_SERVER
        value-from:
          secret:
            name: moldb-database
            key: moldb_server
      - name: POSTGRES_DATABASE
        value-from:
          secret:
            name: moldb-database
            key: moldb_database
      fix-permissions: false # no outputs
    command: >-
      nextflow -log {{ DM_INSTANCE_DIRECTORY }}/nextflow.log
      run {{ CODE_DIRECTORY|default('/code') }}/moldb/enumerate_mols.nf
      --specification '{{ specification }}'
      --count {{ count }}
      --chunk_size {{ chunk_size }}
      -with-trace {{ DM_INSTANCE_DIRECTORY }}/trace.txt
      -with-report {{ DM_INSTANCE_DIRECTORY }}/report.html
    variables:
      order:
        options:
        - count
        - chunk_size
      inputs:
        type: object
        required:
        - specification
        properties:
          specification:
            title: Filter specification file
            mime-types:
            - text/plain
            type: file
      # no outputs
      options:
        type: object
        required:
        - count
        - chunk_size
        properties:
          count:
            title: Max number of molecules to process
            type: integer
            default: 100000
            maxValue: 5000000
          chunk_size:
            title: Chunk size for splitting
            type: integer
            default: 10000
            minValue: 10000
            maxValue: 1000000
    tests:
      simple-enum:
        nextflow-config-file: nextflow-moldb.config
        run-groups:
        - name: moldb
          ordinal: 5
        environment:
        - POSTGRES_USERNAME
        - POSTGRES_PASSWORD
        - POSTGRES_SERVER
        - POSTGRES_DATABASE
        inputs:
          specification: data/14-14-4.spec
        options:
          count: 10000000
          chunk_size: 25
        checks:
          exitCode: 0

  moldb-gen-confs:
    name: MolDB generate conformers
    description: >-
      Generate multiple low energy conformers
    version: '1.0.0'
    category: ligand preparation
    keywords:
    - moldb
    - database
    - conformers
    image:
      name: informaticsmatters/vs-nextflow
      tag: 'latest'
      project-directory: /data
      working-directory: /data
      type: nextflow
      environment:
      - name: POSTGRES_USERNAME
        value-from:
          secret:
            name: moldb-database
            key: moldb_username
      - name: POSTGRES_PASSWORD
        value-from:
          secret:
            name: moldb-database
            key: moldb_password
      - name: POSTGRES_SERVER
        value-from:
          secret:
            name: moldb-database
            key: moldb_server
      - name: POSTGRES_DATABASE
        value-from:
          secret:
            name: moldb-database
            key: moldb_database
      fix-permissions: false # no outputs
    command: >-
      nextflow -log {{ DM_INSTANCE_DIRECTORY }}/nextflow.log
      run {{ CODE_DIRECTORY|default('/code') }}/moldb/generate_confs.nf
      --specification {{ specification }}
      {% if chunk_size is defined %}--chunk_size {{ chunk_size }}{% endif %}
      --count {{ count }}
      -with-trace {{ DM_INSTANCE_DIRECTORY }}/trace.txt
      -with-report {{ DM_INSTANCE_DIRECTORY }}/report.html
    variables:
      order:
        options:
        - count
        - chunk_size
      inputs:
        type: object
        required:
        - specification
        properties:
          specification:
            title: Filter specification file
            mime-types:
            - text/plain
            type: file
      # no outputs
      options:
        type: object
        required:
        - count
        - chunk_size
        properties:
          count:
            title: Max number of molecules to process
            type: integer
            default: 100000
            maxValue: 5000000
          chunk_size:
            title: Chunk size for splitting
            type: integer
            default: 10000
            minValue: 10000
            maxValue: 1000000
    tests:
      simple-confs:
        nextflow-config-file: nextflow-moldb.config
        run-groups:
        - name: moldb
          ordinal: 7
        environment:
        - POSTGRES_USERNAME
        - POSTGRES_PASSWORD
        - POSTGRES_SERVER
        - POSTGRES_DATABASE
        inputs:
          specification: data/14-14-4.spec
        options:
          count: 100000
          chunk_size: 25
        checks:
          exitCode: 0

  moldb-extract-enums:
    name: MolDB extract enumerated forms
    description: >-
      Extract enumerated tautomers, microstates and stereoisomers
    version: '1.0.0'
    category: ligand preparation
    keywords:
    - moldb
    - database
    - enumerate
    - microstates
    - tautomers
    - stereoisomers
    image:
      name: informaticsmatters/vs-moldb
      tag: 'latest'
      project-directory: /data
      working-directory: /data
      type: simple
      environment:
      - name: POSTGRES_USERNAME
        value-from:
          secret:
            name: moldb-database
            key: moldb_username
      - name: POSTGRES_PASSWORD
        value-from:
          secret:
            name: moldb-database
            key: moldb_password
      - name: POSTGRES_SERVER
        value-from:
          secret:
            name: moldb-database
            key: moldb_server
      - name: POSTGRES_DATABASE
        value-from:
          secret:
            name: moldb-database
            key: moldb_database
      fix-permissions: true
    command: >-
      python -m moldb.filter --output-enumerated {{ outfile }}
      --specification {{ specification }}
      --count {{ count }}
      {% if enum_types is defined %}--enum-codes
        {% if 'Base' in enum_types %}B{% endif %}
        {% if 'Tautomer' in enum_types %}T{% endif %}
        {% if 'Microstate' in enum_types %}M{% endif %}
        {% if 'Stereoisomer' in enum_types %}C{% endif %}
      {% endif %}
    variables:
      order:
        options:
        - outfile
        - count
        - enum_types
      inputs:
        type: object
        required:
        - specification
        properties:
          specification:
            title: Filter specification file
            mime-types:
            - text/plain
            type: file
      outputs:
        type: object
        properties:
          outputFile:
            title: Output file
            mime-types:
            - chemical/x-cxsmiles
            - chemical/x-mdl-sdfile
            creates: '{{ outputFile }}'
            type: file
      options:
        type: object
        required:
        - outfile
        - count
        - enum_types
        properties:
          outfile:
            title: Output file name (.cxsmi or .sdf)
            default: enumerated.cxsmi
            pattern: "^[A-Za-z0-9_/\\.\\-]+$"
          count:
            title: Max number of molecules to extract
            type: integer
            default: 100000
            maxValue: 5000000
          enum_types:
            title: Enumerated types
            type: array
            items:
              type: string
              enum:
              - Base
              - Microstate
              - Tautomer
              - Stereoisomer
              default:
              - Base
              - Microstate
              - Tautomer
              - Stereoisomer
    tests:
      create:
        run-groups:
        - name: moldb
          ordinal: 9
        environment:
        - POSTGRES_USERNAME
        - POSTGRES_PASSWORD
        - POSTGRES_SERVER
        - POSTGRES_DATABASE
        inputs:
          specification: data/14-14-4.spec
        options:
          outfile: enumerated.cxsmi
          count: 10
          enum_types:
          - Base
          - Microstate
          - Tautomer
          - Stereoisomer
        checks:
          exitCode: 0
          outputs:
          - name: enumerated.cxsmi
            checks:
            - exists: true
            - lineCount: 10

  moldb-extract-confs:
    name: MolDB extract low energy conformers
    description: >-
      Extract extract low energy conformers
    version: '1.0.0'
    category: ligand preparation
    keywords:
    - moldb
    - database
    - conformer
    - 3d
    image:
      name: informaticsmatters/vs-moldb
      tag: 'latest'
      project-directory: /data
      working-directory: /data
      type: simple
      environment:
      - name: POSTGRES_USERNAME
        value-from:
          secret:
            name: moldb-database
            key: moldb_username
      - name: POSTGRES_PASSWORD
        value-from:
          secret:
            name: moldb-database
            key: moldb_password
      - name: POSTGRES_SERVER
        value-from:
          secret:
            name: moldb-database
            key: moldb_server
      - name: POSTGRES_DATABASE
        value-from:
          secret:
            name: moldb-database
            key: moldb_database
      fix-permissions: true
    command: >-
      python -m moldb.filter --output-conformer {{ outfile }}
      --specification {{ specification }}
      --count {{ count }}
      {% if enum_types is defined %}--enum-codes
        {% if 'Base' in enum_types %}B{% endif %}
        {% if 'Tautomer' in enum_types %}T{% endif %}
        {% if 'Microstate' in enum_types %}M{% endif %}
        {% if 'Stereoisomer' in enum_types %}C{% endif %}
      {% endif %}
    variables:
      order:
        options:
        - outfile
        - count
        - enum_types
      inputs:
        type: object
        required:
        - specification
        properties:
          specification:
            title: Filter specification file
            mime-types:
            - text/plain
            type: file
      outputs:
        type: object
        properties:
          outputFile:
            title: Output file
            mime-types:
            - chemical/x-cxsmiles
            - chemical/x-mdl-sdfile
            creates: '{{ outputFile }}'
            type: file
      options:
        type: object
        required:
        - outfile
        - count
        - enum_types
        properties:
          outfile:
            title: Output file name (.cxsmi or .sdf)
            default: conformers.cxsmi
            pattern: "^[A-Za-z0-9_/\\.\\-]+$"
          count:
            title: Max number of molecules to extract
            type: integer
            default: 100000
            maxValue: 5000000
          enum_types:
            title: Enumerated types
            type: array
            items:
              type: string
              enum:
              - Base
              - Microstate
              - Tautomer
              - Stereoisomer
              default:
              - Base
              - Microstate
              - Tautomer
              - Stereoisomer
    tests:
      create:
        run-groups:
        - name: moldb
          ordinal: 10
        environment:
        - POSTGRES_USERNAME
        - POSTGRES_PASSWORD
        - POSTGRES_SERVER
        - POSTGRES_DATABASE
        inputs:
          specification: data/14-14-4.spec
        options:
          outfile: conformers.cxsmi
          count: 10
          enum_types:
          - Base
          - Microstate
          - Tautomer
          - Stereoisomer
        checks:
          exitCode: 0
          outputs:
          - name: conformers.cxsmi
            checks:
            - exists: true
            - lineCount: 10
